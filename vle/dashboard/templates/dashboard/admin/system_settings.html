{% extends "main.html" %}

{% block title %}System Settings - Admin Panel{% endblock %}

{% block navigation %}
    {% include "admin_navigation.html" %}
{% endblock %}

{% block body %}
<div class="system-settings">
    <!-- Page Header with Save Button -->
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-cogs"></i> System Settings
                </h1>
                <p class="page-subtitle">
                    Configure global system variables and preferences
                </p>
            </div>
            <button id="saveAllChanges" class="btn btn-primary" style="display: none;">
                <i class="fas fa-save"></i> Save All Changes
            </button>
        </div>
    </div>

    <!-- Settings Tabs -->
    <div class="settings-tabs-container card">
        <div class="settings-tabs">
            <button class="tab active" onclick="switchSettingsTab('general')">
                <i class="fas fa-sliders-h"></i> General
            </button>
            <button class="tab" onclick="switchSettingsTab('maintenance')">
                <i class="fas fa-tools"></i> Maintenance
            </button>
            <button class="tab" onclick="switchSettingsTab('uploads')">
                <i class="fas fa-upload"></i> Uploads
            </button>
            <button class="tab" onclick="switchSettingsTab('email')">
                <i class="fas fa-envelope"></i> Email
            </button>
            <button class="tab" onclick="switchSettingsTab('security')">
                <i class="fas fa-shield-alt"></i> Security
            </button>
        </div>
    </div>

    <!-- General Settings -->
    <div id="generalTab" class="settings-tab-content active">
        <div class="settings-section card">
            <div class="settings-section-header">
                <h3><i class="fas fa-globe"></i> General Configuration</h3>
            </div>
            <div class="settings-section-body">
                <!-- SYSTEM_NAME -->
                <div class="form-group setting-item" data-key="SYSTEM_NAME" data-type="str">
                    <label class="form-label">System Name</label>
                    <input type="text" 
                           class="form-control setting-input" 
                           data-original="{{ settings.SYSTEM_NAME|default:'UOV VLE' }}"
                           value="{{ settings.SYSTEM_NAME|default:'UOV VLE' }}">
                    <div class="form-help">Display name for the application</div>
                </div>

                <!-- SYSTEM_TAGLINE -->
                <div class="form-group setting-item" data-key="SYSTEM_TAGLINE" data-type="str">
                    <label class="form-label">System Tagline</label>
                    <input type="text" 
                           class="form-control setting-input" 
                           data-original="{{ settings.SYSTEM_TAGLINE|default:'' }}"
                           value="{{ settings.SYSTEM_TAGLINE|default:'' }}">
                    <div class="form-help">Optional tagline or subtitle</div>
                </div>

                <!-- USERS_PER_PAGE -->
                <div class="form-group setting-item" data-key="USERS_PER_PAGE" data-type="int">
                    <label class="form-label">Users Per Page</label>
                    <input type="number" 
                           class="form-control setting-input" 
                           data-original="{{ settings.USERS_PER_PAGE|default:50 }}"
                           value="{{ settings.USERS_PER_PAGE|default:50 }}"
                           min="10" max="200">
                    <div class="form-help">Number of users displayed per page in lists</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Settings -->
    <div id="maintenanceTab" class="settings-tab-content">
        <div class="settings-section card">
            <div class="settings-section-header">
                <h3><i class="fas fa-tools"></i> Maintenance Settings</h3>
            </div>
            <div class="settings-section-body">
                <!-- MAINTENANCE_MODE -->
                <div class="form-group setting-item" data-key="MAINTENANCE_MODE" data-type="bool">
                    <label class="checkbox">
                        <input type="checkbox" 
                               class="setting-input"
                               data-original="{{ settings.MAINTENANCE_MODE|default:'false' }}"
                               {% if settings.MAINTENANCE_MODE %}checked{% endif %}>
                        <span>Maintenance Mode</span>
                    </label>
                    <div class="form-help">When enabled, only allowed roles can access the system</div>
                </div>

                <!-- MAINTENANCE_MESSAGE -->
                <div class="form-group setting-item" data-key="MAINTENANCE_MESSAGE" data-type="str">
                    <label class="form-label">Maintenance Message</label>
                    <textarea class="form-control setting-input" 
                              data-original="{{ settings.MAINTENANCE_MESSAGE|default:'System is under maintenance. Try again later.' }}">
{{ settings.MAINTENANCE_MESSAGE|default:'System is under maintenance. Try again later.' }}</textarea>
                    <div class="form-help">Message shown to users during maintenance</div>
                </div>

                <!-- MAINTENANCE_ALLOWED_ROLES -->
                <div class="form-group setting-item" data-key="MAINTENANCE_ALLOWED_ROLES" data-type="list">
                    <label class="form-label">Allowed Roles During Maintenance</label>
                    <div class="role-checkboxes">
                        <label class="checkbox">
                            <input type="checkbox" value="admin" class="role-checkbox" {% if 'admin' in settings.MAINTENANCE_ALLOWED_ROLES %}checked{% endif %}>
                            <span>Admin</span>
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" value="staff" class="role-checkbox" {% if 'staff' in settings.MAINTENANCE_ALLOWED_ROLES %}checked{% endif %}>
                            <span>Staff</span>
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" value="instructor" class="role-checkbox" {% if 'instructor' in settings.MAINTENANCE_ALLOWED_ROLES %}checked{% endif %}>
                            <span>Instructor</span>
                        </label>
                    </div>
                    <input type="hidden" class="setting-input hidden-roles-input" 
                           data-original='["admin"]'
                           value='["admin"]'>
                    <div class="form-help">Roles that can access the system during maintenance</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Settings -->
    <div id="uploadsTab" class="settings-tab-content">
        <div class="settings-section card">
            <div class="settings-section-header">
                <h3><i class="fas fa-upload"></i> Upload Settings</h3>
            </div>
            <div class="settings-section-body">
                <!-- MAX_UPLOAD_MB -->
                <div class="form-group setting-item" data-key="MAX_UPLOAD_MB" data-type="int">
                    <label class="form-label">Maximum Upload Size (MB)</label>
                    <input type="number" 
                           class="form-control setting-input" 
                           data-original="{{ settings.MAX_UPLOAD_MB|default:10 }}"
                           value="{{ settings.MAX_UPLOAD_MB|default:10 }}"
                           min="1" max="100">
                    <div class="form-help">Maximum file size allowed for uploads</div>
                </div>

                <!-- ALLOWED_FILE_EXTENSIONS -->
                <div class="form-group setting-item" data-key="ALLOWED_FILE_EXTENSIONS" data-type="str">
                    <label class="form-label">Allowed File Extensions</label>
                    <input type="text" 
                           class="form-control setting-input" 
                           data-original="{{ settings.ALLOWED_FILE_EXTENSIONS|default:'.pdf,.doc,.docx,.jpg,.jpeg,.png' }}"
                           value="{{ settings.ALLOWED_FILE_EXTENSIONS|default:'.pdf,.doc,.docx,.jpg,.jpeg,.png' }}">
                    <div class="form-help">Comma-separated list of allowed file extensions</div>
                </div>

                <!-- BLOCK_EXECUTABLE_UPLOADS -->
                <div class="form-group setting-item" data-key="BLOCK_EXECUTABLE_UPLOADS" data-type="bool">
                    <label class="checkbox">
                        <input type="checkbox" 
                               class="setting-input"
                               data-original="{{ settings.BLOCK_EXECUTABLE_UPLOADS|default:'true' }}"
                               {% if settings.BLOCK_EXECUTABLE_UPLOADS %}checked{% endif %}>
                        <span>Block Executable File Uploads</span>
                    </label>
                    <div class="form-help">Prevent uploading of executable files (.exe, .bat, .sh, etc.)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Settings -->
    <div id="emailTab" class="settings-tab-content">
        <div class="settings-section card">
            <div class="settings-section-header">
                <h3><i class="fas fa-envelope"></i> Email Settings</h3>
            </div>
            <div class="settings-section-body">
                <!-- EMAIL_ENABLED -->
                <div class="form-group setting-item" data-key="EMAIL_ENABLED" data-type="bool">
                    <label class="checkbox">
                        <input type="checkbox" 
                               class="setting-input"
                               data-original="{{ settings.EMAIL_ENABLED|default:'false' }}"
                               {% if settings.EMAIL_ENABLED %}checked{% endif %}>
                        <span>Enable Email System</span>
                    </label>
                    <div class="form-help">Enable or disable the email system</div>
                </div>

                <!-- EMAIL_PROVIDER -->
                <div class="form-group setting-item" data-key="EMAIL_PROVIDER" data-type="str">
                    <label class="form-label">Email Provider</label>
                    <select class="form-control setting-input" 
                            data-original="{{ settings.EMAIL_PROVIDER|default:'none' }}">
                        <option value="none" {% if settings.EMAIL_PROVIDER == 'none' %}selected{% endif %}>None</option>
                        <option value="smtp" {% if settings.EMAIL_PROVIDER == 'smtp' %}selected{% endif %}>SMTP</option>
                        <option value="sendgrid" {% if settings.EMAIL_PROVIDER == 'sendgrid' %}selected{% endif %}>SendGrid</option>
                        <option value="mailgun" {% if settings.EMAIL_PROVIDER == 'mailgun' %}selected{% endif %}>Mailgun</option>
                    </select>
                    <div class="form-help">Email service provider to use</div>
                </div>

                <!-- EMAIL_FROM_NAME -->
                <div class="form-group setting-item" data-key="EMAIL_FROM_NAME" data-type="str">
                    <label class="form-label">From Name</label>
                    <input type="text" 
                           class="form-control setting-input" 
                           data-original="{{ settings.EMAIL_FROM_NAME|default:'UOV VLE' }}"
                           value="{{ settings.EMAIL_FROM_NAME|default:'UOV VLE' }}">
                    <div class="form-help">Display name for sent emails</div>
                </div>

                <!-- EMAIL_FROM_ADDRESS -->
                <div class="form-group setting-item" data-key="EMAIL_FROM_ADDRESS" data-type="str">
                    <label class="form-label">From Address</label>
                    <input type="email" 
                           class="form-control setting-input" 
                           data-original="{{ settings.EMAIL_FROM_ADDRESS|default:'noreply@university.edu' }}"
                           value="{{ settings.EMAIL_FROM_ADDRESS|default:'noreply@university.edu' }}">
                    <div class="form-help">Email address for sent emails</div>
                </div>

                <!-- EMAIL_REPLY_TO -->
                <div class="form-group setting-item" data-key="EMAIL_REPLY_TO" data-type="str">
                    <label class="form-label">Reply-To Address</label>
                    <input type="email" 
                           class="form-control setting-input" 
                           data-original="{{ settings.EMAIL_REPLY_TO|default:'' }}"
                           value="{{ settings.EMAIL_REPLY_TO|default:'' }}">
                    <div class="form-help">Reply-to email address (optional)</div>
                </div>

                <!-- EMAIL_FOOTER_TEXT -->
                <div class="form-group setting-item" data-key="EMAIL_FOOTER_TEXT" data-type="str">
                    <label class="form-label">Email Footer Text</label>
                    <textarea class="form-control setting-input" 
                              data-original="{{ settings.EMAIL_FOOTER_TEXT|default:'' }}">
{{ settings.EMAIL_FOOTER_TEXT|default:'' }}</textarea>
                    <div class="form-help">Text to include in email footer (optional)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div id="securityTab" class="settings-tab-content">
        <div class="settings-section card">
            <div class="settings-section-header">
                <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
            </div>
            <div class="settings-section-body">
                <!-- PASSWORD_RESET_ENABLED -->
                <div class="form-group setting-item" data-key="PASSWORD_RESET_ENABLED" data-type="bool">
                    <label class="checkbox">
                        <input type="checkbox" 
                               class="setting-input"
                               data-original="{{ settings.PASSWORD_RESET_ENABLED|default:'false' }}"
                               {% if settings.PASSWORD_RESET_ENABLED %}checked{% endif %}>
                        <span>Enable Password Reset</span>
                    </label>
                    <div class="form-help">Allow users to reset their passwords via email</div>
                </div>

                <!-- RESET_TOKEN_EXPIRY_MIN -->
                <div class="form-group setting-item" data-key="RESET_TOKEN_EXPIRY_MIN" data-type="int">
                    <label class="form-label">Password Reset Token Expiry (minutes)</label>
                    <input type="number" 
                           class="form-control setting-input" 
                           data-original="{{ settings.RESET_TOKEN_EXPIRY_MIN|default:30 }}"
                           value="{{ settings.RESET_TOKEN_EXPIRY_MIN|default:30 }}"
                           min="1" max="1440">
                    <div class="form-help">How long password reset tokens remain valid</div>
                </div>

                <!-- RESET_LINK_BASE_URL -->
                <div class="form-group setting-item" data-key="RESET_LINK_BASE_URL" data-type="str">
                    <label class="form-label">Password Reset Link Base URL</label>
                    <input type="text" 
                           class="form-control setting-input" 
                           data-original="{{ settings.RESET_LINK_BASE_URL|default:'' }}"
                           value="{{ settings.RESET_LINK_BASE_URL|default:'' }}">
                    <div class="form-help">Base URL for password reset links (leave empty for auto-detection)</div>
                </div>

                <!-- FORCE_PASSWORD_CHANGE_ON_FIRST_LOGIN -->
                <div class="form-group setting-item" data-key="FORCE_PASSWORD_CHANGE_ON_FIRST_LOGIN" data-type="bool">
                    <label class="checkbox">
                        <input type="checkbox" 
                               class="setting-input"
                               data-original="{{ settings.FORCE_PASSWORD_CHANGE_ON_FIRST_LOGIN|default:'true' }}"
                               {% if settings.FORCE_PASSWORD_CHANGE_ON_FIRST_LOGIN %}checked{% endif %}>
                        <span>Force Password Change on First Login</span>
                    </label>
                    <div class="form-help">Require users to change their password on first login</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Saving Settings...</div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toastNotification">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Settings saved successfully</span>
</div>
{% endblock %}

{% block style %}
<style>
    .system-settings {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Page Header */
    .page-header {
        margin-bottom: 1rem;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 2rem;
        color: var(--dark);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #666;
        font-size: 1rem;
    }

    /* Settings Tabs */
    .settings-tabs-container {
        padding: 0;
        overflow: hidden;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .settings-tabs {
        display: flex;
        border-bottom: 2px solid #f0f0f0;
        overflow-x: auto;
    }

    .settings-tabs .tab {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        font-size: 0.95rem;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s ease;
        position: relative;
        white-space: nowrap;
    }

    .settings-tabs .tab:hover {
        color: #3b2fd4;
        background: #f8f9ff;
    }

    .settings-tabs .tab.active {
        color: #3b2fd4;
    }

    .settings-tabs .tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #3b2fd4;
    }

    /* Tab Content */
    .settings-tab-content {
        display: none;
    }

    .settings-tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Settings Sections */
    .settings-section {
        margin-bottom: 1.5rem;
    }

    .settings-section-header {
        padding: 1.25rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .settings-section-header h3 {
        font-size: 1.1rem;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .settings-section-body {
        padding: 1.25rem;
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .setting-item.setting-changed {
        background: #f8f9ff;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #3b2fd4;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #3b2fd4;
        box-shadow: 0 0 0 3px rgba(59, 47, 212, 0.1);
    }

    .form-help {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }

    /* Checkbox Group */
    .checkbox {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }

    .checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #3b2fd4;
    }

    .checkbox span {
        font-size: 0.95rem;
        color: var(--dark);
    }

    /* Role Checkboxes */
    .role-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    /* Hidden input for roles */
    .hidden-roles-input {
        display: none;
    }

    /* Button Styling */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b2fd4 0%, #2a1bb7 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 47, 212, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3b2fd4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 1rem;
        color: #3b2fd4;
        font-weight: 600;
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        transform: translateY(100px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    .toast.error {
        background: #ef4444;
    }

    .toast.warning {
        background: #f59e0b;
    }

    .toast.info {
        background: #3b82f6;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .settings-tabs {
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .settings-tabs .tab {
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }
        
        .btn {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .settings-section-header,
        .settings-section-body {
            padding: 1rem;
        }
        
        .role-checkboxes {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block script %}
<script>
    class SettingsManager {
        constructor() {
            this.originalSettings = {};
            this.currentSettings = {};
            this.changedSettings = new Map();
            this.isLoading = false;
            this.updateInterval = null;
            this.autoUpdateInterval = 30000; // 30 seconds
            
            this.init();
        }
        
        init() {
            this.loadInitialSettings();
            this.setupEventListeners();
            this.loadSettingsFromAPI();
            this.setupAutoUpdate();
        }
        
        loadInitialSettings() {
            // Extract settings from data attributes
            document.querySelectorAll('.setting-item').forEach(item => {
                const key = item.dataset.key;
                const type = item.dataset.type;
                const input = this.getInputElement(item);
                
                if (input) {
                    let originalValue;
                    
                    // Special handling for MAINTENANCE_ALLOWED_ROLES
                    if (key === 'MAINTENANCE_ALLOWED_ROLES') {
                        originalValue = this.getRolesFromCheckboxes();
                    } else {
                        originalValue = this.parseValue(input.dataset.original, type);
                    }
                    
                    this.originalSettings[key] = originalValue;
                    this.currentSettings[key] = originalValue;
                }
            });
        }
        
        setupEventListeners() {
            // Input change events
            document.querySelectorAll('.setting-input').forEach(input => {
                if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => this.onSettingChange(e));
                } else {
                    input.addEventListener('input', (e) => this.onSettingChange(e));
                }
            });
            
            // Role checkboxes
            document.querySelectorAll('.role-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => this.onRoleCheckboxChange(e));
            });
            
            // Save button
            document.getElementById('saveAllChanges').addEventListener('click', () => this.saveChanges());
        }
        
        onSettingChange(event) {
            const input = event.target;
            const item = input.closest('.setting-item');
            if (!item) return;
            
            const key = item.dataset.key;
            const type = item.dataset.type;
            const newValue = this.getValueFromInput(input, type);
            
            this.updateSetting(key, newValue, item);
        }
        
        onRoleCheckboxChange(event) {
            const key = 'MAINTENANCE_ALLOWED_ROLES';
            const newValue = this.getRolesFromCheckboxes();
            const item = document.querySelector(`.setting-item[data-key="${key}"]`);
            
            if (item) {
                this.updateSetting(key, newValue, item);
            }
        }
        
        getRolesFromCheckboxes() {
            const checkboxes = document.querySelectorAll('.role-checkbox');
            return Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }
        
        updateSetting(key, newValue, item) {
            const originalValue = this.originalSettings[key];
            
            // Compare with original value
            const hasChanged = JSON.stringify(newValue) !== JSON.stringify(originalValue);
            
            if (hasChanged) {
                this.changedSettings.set(key, newValue);
                this.currentSettings[key] = newValue;
                
                // Mark as changed in UI
                item.classList.add('setting-changed');
            } else {
                this.changedSettings.delete(key);
                this.currentSettings[key] = originalValue;
                
                // Remove changed mark
                item.classList.remove('setting-changed');
            }
            
            this.updateSaveButton();
        }
        
        async loadSettingsFromAPI() {
            try {
                console.log('Fetching settings from API...');
                const response = await fetch('/api/get-all-setting/');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.detail || `HTTP ${response.status}: ${response.statusText}`;
                    this.showToast(`Failed to load settings: ${errorMessage}`, 'error');
                    return;
                }
                
                const apiSettings = await response.json();
                console.log('API settings received:', apiSettings);
                
                // Update UI with API values
                this.updateUIFromAPISettings(apiSettings);
                
            } catch (error) {
                console.error('Error loading settings from API:', error);
                this.showToast('Network error: Failed to connect to server', 'error');
            }
        }
        
        updateUIFromAPISettings(apiSettings) {
            let updatedCount = 0;
            
            Object.entries(apiSettings).forEach(([key, value]) => {
                const item = document.querySelector(`.setting-item[data-key="${key}"]`);
                if (item) {
                    // Only update if not changed by user
                    if (!this.changedSettings.has(key)) {
                        const input = this.getInputElement(item);
                        const type = item.dataset.type;
                        
                        // Parse and update value
                        const parsedValue = this.parseValue(value, type);
                        
                        // Update input value
                        this.setInputValue(input, parsedValue, type);
                        
                        // Update data-original attribute
                        input.dataset.original = this.serializeValue(parsedValue, type);
                        
                        // Update original settings
                        this.originalSettings[key] = parsedValue;
                        this.currentSettings[key] = parsedValue;
                        
                        // Special handling for roles
                        if (key === 'MAINTENANCE_ALLOWED_ROLES') {
                            this.updateRoleCheckboxes(parsedValue);
                        }
                        
                        updatedCount++;
                        console.log(`Updated ${key} from API:`, parsedValue);
                    }
                }
            });
            
            if (updatedCount > 0) {
                console.log(`Updated ${updatedCount} settings from API`);
                this.showToast(`Settings updated from server (${updatedCount} values)`, 'info');
            }
        }
        
        updateRoleCheckboxes(roles) {
            document.querySelectorAll('.role-checkbox').forEach(checkbox => {
                checkbox.checked = roles.includes(checkbox.value);
            });
        }
        
        async saveChanges() {
            if (this.changedSettings.size === 0 || this.isLoading) return;
            
            this.isLoading = true;
            const saveBtn = document.getElementById('saveAllChanges');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Create array of update promises
                const updatePromises = Array.from(this.changedSettings.entries()).map(([key, value]) => {
                    return this.updateSettingAPI(key, value);
                });
                
                // Send updates in parallel
                const results = await Promise.allSettled(updatePromises);
                
                // Check results
                const successfulUpdates = [];
                const failedUpdates = [];
                
                results.forEach((result, index) => {
                    const key = Array.from(this.changedSettings.keys())[index];
                    if (result.status === 'fulfilled') {
                        successfulUpdates.push(key);
                    } else {
                        failedUpdates.push({
                            key: key,
                            error: result.reason
                        });
                    }
                });
                
                if (failedUpdates.length === 0) {
                    // Success - update original settings
                    this.changedSettings.forEach((value, key) => {
                        this.originalSettings[key] = value;
                        
                        // Remove changed mark
                        const item = document.querySelector(`.setting-item[data-key="${key}"]`);
                        if (item) {
                            item.classList.remove('setting-changed');
                        }
                    });
                    
                    this.changedSettings.clear();
                    this.updateSaveButton();
                    
                    // Show success message
                    this.showToast(`${successfulUpdates.length} settings saved successfully`, 'success');
                    
                    // Refresh from API to get any server-side validations
                    setTimeout(() => this.loadSettingsFromAPI(), 1000);
                } else {
                    // Some updates failed
                    const errorMessages = failedUpdates.map(f => `${f.key}: ${f.error.message}`).join(', ');
                    this.showToast(`Failed to save ${failedUpdates.length} settings: ${errorMessages}`, 'error');
                    
                    // Keep successful changes in changedSettings
                    failedUpdates.forEach(failed => {
                        // Failed ones stay in changedSettings
                    });
                    
                    // Remove successful ones from changedSettings
                    successfulUpdates.forEach(key => {
                        this.changedSettings.delete(key);
                        const item = document.querySelector(`.setting-item[data-key="${key}"]`);
                        if (item) {
                            item.classList.remove('setting-changed');
                        }
                    });
                    
                    this.updateSaveButton();
                }
                
            } catch (error) {
                console.error('Error saving settings:', error);
                this.showToast(`Error saving settings: ${error.message}`, 'error');
            } finally {
                this.isLoading = false;
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        async updateSettingAPI(key, value) {
            const csrfToken = this.getCSRFToken();
            
            const response = await fetch('/api/update-setting/', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    key: key,
                    value: value
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.detail || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMessage);
            }
            
            return response.json();
        }
        
        updateSaveButton() {
            const saveBtn = document.getElementById('saveAllChanges');
            if (this.changedSettings.size > 0) {
                saveBtn.style.display = 'flex';
                saveBtn.innerHTML = `<i class="fas fa-save"></i> Save ${this.changedSettings.size} Change(s)`;
            } else {
                saveBtn.style.display = 'none';
            }
        }
        
        // Helper methods
        getInputElement(item) {
            return item.querySelector('.setting-input');
        }
        
        getValueFromInput(input, type) {
            switch (type) {
                case 'bool':
                    return input.type === 'checkbox' ? input.checked : input.value === 'true';
                case 'int':
                    return parseInt(input.value) || 0;
                case 'list':
                    if (input.classList.contains('hidden-roles-input')) {
                        return this.getRolesFromCheckboxes();
                    }
                    return input.value ? input.value.split(',') : [];
                default:
                    return input.value;
            }
        }
        
        setInputValue(input, value, type) {
            switch (type) {
                case 'bool':
                    if (input.type === 'checkbox') {
                        input.checked = value;
                    } else {
                        input.value = value ? 'true' : 'false';
                    }
                    break;
                case 'int':
                    input.value = parseInt(value) || 0;
                    break;
                case 'list':
                    if (input.type === 'hidden') {
                        input.value = JSON.stringify(value || []);
                    } else if (input.tagName === 'SELECT') {
                        input.value = value;
                    }
                    break;
                default:
                    if (input.tagName === 'SELECT') {
                        input.value = value;
                    } else if (input.tagName === 'TEXTAREA') {
                        input.value = value || '';
                    } else {
                        input.value = value || '';
                    }
            }
        }
        
        parseValue(value, type) {
            if (value === undefined || value === null) {
                switch (type) {
                    case 'bool': return false;
                    case 'int': return 0;
                    case 'list': return [];
                    default: return '';
                }
            }
            
            switch (type) {
                case 'bool':
                    // Handle string values like 'true', 'false'
                    if (typeof value === 'string') {
                        return value.toLowerCase() === 'true';
                    }
                    return Boolean(value);
                case 'int':
                    return parseInt(value) || 0;
                case 'list':
                    if (typeof value === 'string') {
                        try {
                            return JSON.parse(value);
                        } catch {
                            return value ? value.split(',') : [];
                        }
                    }
                    return Array.isArray(value) ? value : [];
                default:
                    return String(value);
            }
        }
        
        serializeValue(value, type) {
            switch (type) {
                case 'bool':
                    return value ? 'true' : 'false';
                case 'list':
                    return JSON.stringify(value || []);
                default:
                    return String(value || '');
            }
        }
        
        getCSRFToken() {
            // Try to get CSRF token from cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            
            // Clear any existing timeout
            if (toast.timeoutId) {
                clearTimeout(toast.timeoutId);
            }
            
            // Show toast
            toast.classList.add('show');
            
            // Auto-hide after 5 seconds for errors, 3 seconds for others
            const hideTime = type === 'error' ? 5000 : 3000;
            toast.timeoutId = setTimeout(() => {
                toast.classList.remove('show');
            }, hideTime);
        }
        
        setupAutoUpdate() {
            // Clear any existing interval
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
            }
            
            // Set up new interval
            this.updateInterval = setInterval(() => {
                this.loadSettingsFromAPI();
            }, this.autoUpdateInterval);
            
            console.log('Auto-update interval set for every', this.autoUpdateInterval / 1000, 'seconds');
        }
        
        cleanup() {
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
                this.updateInterval = null;
            }
        }
    }
    
    // Tab switching
    function switchSettingsTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.settings-tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.settings-tabs .tab').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // Activate selected tab button
        document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing Settings Manager...');
        // Initialize settings manager
        window.settingsManager = new SettingsManager();
        
        // Initialize first tab as active
        switchSettingsTab('general');
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (window.settingsManager) {
                window.settingsManager.cleanup();
            }
        });
    });
</script>
{% endblock %}