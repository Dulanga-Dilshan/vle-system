{% extends "main.html" %}

{% block title %}{{ batch.name }} - Batch Management - University VLE{% endblock %}

{% block navigation %}
    {% include "admin_navigation.html" %}
{% endblock %}

{% block body %}
<div class="batch-detail-management" data-batch-id="{{ batch.id }}">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">
                <i class="fas fa-calendar-alt"></i> {{ batch.name }}
            </h1>
            <p class="page-subtitle">
                Manage students and academic progression
            </p>
        </div>
        <div class="header-actions">
            <a href="{% url 'dashboard:manage_batches' %}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Back to Batches
            </a>
            <button class="btn btn-primary" onclick="openAddStudentsModal()">
                <i class="fas fa-user-plus"></i> Add Students
            </button>
        </div>
    </div>

    <!-- Batch Info Card -->
    <div class="batch-info-card card">
        <div class="batch-header-info">
            <div class="batch-avatar">{{ batch.course.name|first|upper }}</div>
            <div class="batch-details">
                <h2>{{ batch.name }}</h2>
                <div class="batch-meta">
                    <span class="meta-item">
                        <i class="fas fa-book"></i>
                        Course: {{ batch.course.name|default:"Not Assigned" }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-calendar"></i>
                        Intake Year: {{ batch.intake_year }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-users"></i>
                        Students: {{ students|length }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="students-tab">
                <i class="fas fa-users"></i> Students
            </button>
            <button class="tab-btn" data-tab="progress-tab">
                <i class="fas fa-chart-line"></i> Progress & Semesters
            </button>
        </div>
    </div>

    <!-- Students Tab -->
    <div class="tab-content active" id="students-tab">
        <div class="students-management">
            <div class="section-header">
                <h2>
                    <i class="fas fa-users"></i> Batch Students
                </h2>
                <div class="student-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchStudent" placeholder="Search students...">
                    </div>
                    <button class="btn btn-outline" onclick="openCSVUploadModal()">
                        <i class="fas fa-file-upload"></i> Bulk Upload
                    </button>
                </div>
            </div>

            <!-- Student Selection Actions -->
            <div class="bulk-actions" id="bulkActions" style="display: none;">
                <div class="bulk-actions-content">
                    <span id="selectedCount">0</span> students selected
                    <div class="bulk-buttons">
                        <button class="btn btn-sm btn-outline" onclick="clearSelection()">
                            Clear
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeSelectedStudents()">
                            <i class="fas fa-trash"></i> Remove Selected
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="updateSelectedProgress()">
                            <i class="fas fa-forward"></i> Update Progress
                        </button>
                    </div>
                </div>
            </div>

            {% if students %}
            <div class="students-table">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                                </th>
                                <th>Student</th>
                                <th>Student ID</th>
                                <th>Email</th>
                                <th>Current Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr data-student-id="{{ student.id }}" data-progress="{{ student.progress_year|default:'1.1' }}">
                                <td>
                                    <input type="checkbox" class="student-checkbox" value="{{ student.id }}">
                                </td>
                                <td>
                                    <div class="student-info-cell">
                                        <div class="student-avatar">
                                            {{ student.name|first|upper }}
                                        </div>
                                        <div>
                                            <strong>{{ student.name }}</strong>
                                            <small>Joined: {{ student.joined_date|date:"M d, Y"|default:"N/A" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ student.username|default:"-" }}</td>
                                <td>{{ student.email|default:"-" }}</td>
                                <td>
                                    <span class="progress-badge" data-progress="{{ student.progress_year|default:'1.1' }}">
                                        {{ student.progress_year|default:"1.1" }}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-danger" onclick="removeStudent({{ student.id }}, '{{ student.name }}')" title="Remove from Batch">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>No Students in Batch</h3>
                <p>Add students to start managing this batch</p>
                <button class="btn btn-primary" onclick="openAddStudentsModal()">
                    <i class="fas fa-user-plus"></i> Add Students
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Progress & Semesters Tab -->
    <div class="tab-content" id="progress-tab">
        <div class="progress-management">
            <div class="section-header">
                <h2>
                    <i class="fas fa-chart-line"></i> Academic Progress
                </h2>
                <div class="progress-actions">
                    <button class="btn btn-primary" onclick="advanceEntireBatch()">
                        <i class="fas fa-forward"></i> Advance Entire Batch
                    </button>
                </div>
            </div>

            <!-- Progress Timeline -->
            <div class="progress-timeline">
                <div class="timeline-header">
                    <h3>Semester Progression</h3>
                    <small>Click on a semester to view students in that stage</small>
                </div>
                
                <div class="timeline">
                    {% for year in "1234"|make_list %}
                    <div class="timeline-year">
                        <div class="year-header">
                            <h4>Year {{ year }}</h4>
                            <span class="year-stats">
                                {% with year=year|add:"0" %}
                                    {{ students_by_progress.year|default:0 }} students
                                {% endwith %}
                            </span>
                        </div>
                        <div class="semester-grid">
                            {% for semester in "12"|make_list %}
                            {% with progress=year|add:'.'|add:semester %}
                            <div class="semester-card" data-progress="{{ progress }}" onclick="viewStudentsInProgress('{{ progress }}')">
                                <div class="semester-header">
                                    <h5>{{ progress }}</h5>
                                    <span class="student-count">
                                        {% with progress_key=progress %}
                                            {{ students_by_progress.progress_key|default:0 }}
                                        {% endwith %}
                                    </span>
                                </div>
                                <div class="semester-body">
                                    <div class="progress-indicator">
                                        {% with progress_key=progress total=students|length %}
                                        <div class="progress-bar" style="width: {% widthratio students_by_progress.progress_key|default:0 total 100 %}%"></div>
                                        {% endwith %}
                                    </div>
                                    <small>{% widthratio students_by_progress.progress_key|default:0 students|length 100 %}% of batch</small>
                                </div>
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Progress Statistics -->
            <div class="progress-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ students_by_progress.4.2|default:0 }}</h3>
                        <p>Final Year Students</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ average_progress|default:"1.1" }}</h3>
                        <p>Average Progress</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-flag-checkered"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ completion_rate|default:0 }}%</h3>
                        <p>Completion Rate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Students Modal -->
<div class="modal-overlay" id="addStudentsModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Add Students to Batch</h3>
            <button class="modal-close" onclick="closeAddStudentsModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="modal-subheader">
                <h4>Select Students to Add</h4>
                <div class="search-box modal-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="studentSearch" placeholder="Search students by name, ID, or email..." oninput="filterStudents()">
                </div>
            </div>
            
            <!-- Student Selection Options -->
            <div class="student-selection-options">
                <div class="select-all">
                    <label class="checkbox-label">
                        <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllModal(this)">
                        <span class="checkmark"></span>
                        Select All Visible
                    </label>
                </div>
                <div class="selected-info">
                    <span id="selectedStudentsCount">0</span> selected
                </div>
            </div>
            
            <!-- Students List -->
            <div class="students-list-container">
                {% if all_students %}
                <div class="students-list" id="studentsList">
                    {% for student in all_students %}
                    <div class="student-select-item" data-student-id="{{ student.id }}">
                        <div class="student-info">
                            <label class="checkbox-label">
                                <input type="checkbox" class="student-select-checkbox" 
                                       value="{{ student.id }}"
                                       onchange="updateSelectionCount()">
                                <span class="checkmark"></span>
                            </label>
                            <div class="student-avatar-small">
                                {{ student.name|first|upper }}
                            </div>
                            <div class="student-details">
                                <strong>{{ student.name }}</strong>
                                <small>{{ student.email|default:"No email" }}</small>
                                {% if student.username %}
                                <small class="student-id">ID: {{ student.username }}</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="student-status">
                            {% if student.batch %}
                                {% if student.batch.id == batch.id %}
                                <span class="status-badge status-current-batch">
                                    <i class="fas fa-check-circle"></i> Already in this batch
                                </span>
                                {% else %}
                                <span class="status-badge status-other-batch" title="Current Batch: {{ student.batch.name }}">
                                    <i class="fas fa-calendar-alt"></i> {{ student.batch.name }}
                                </span>
                                {% if student.progress_year %}
                                <small class="batch-info">
                                    Progress: {{ student.progress_year }}
                                </small>
                                {% endif %}
                                {% endif %}
                            {% else %}
                            <span class="status-badge status-unassigned">Unassigned</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-small">
                    <i class="fas fa-users"></i>
                    <h4>No Students Available</h4>
                    <p>All students are already in this batch</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Note for transferring students -->
            <div class="transfer-note">
                <i class="fas fa-info-circle"></i>
                <p>Students already in other batches will be transferred to this batch. Their academic progress will be preserved.</p>
            </div>
            
            <!-- Modal Actions -->
            <div class="modal-actions">
                <div class="selected-summary" id="selectedSummary">
                    <i class="fas fa-users"></i>
                    <span id="totalSelectedCount">0</span> student(s) selected
                    <button type="button" class="btn btn-sm btn-outline" onclick="clearAllSelection()">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline" onclick="closeAddStudentsModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSelectedStudents()" id="addStudentsBtn" disabled>
                        <i class="fas fa-user-plus"></i> Add Selected Students
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Upload Modal with Editable CSV Table -->
<div class="modal-overlay" id="csvUploadModal" style="display: none;">
    <div class="modal" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 class="modal-title">Bulk Upload Students</h3>
            <button class="modal-close" onclick="closeCSVUploadModal()">&times;</button>
        </div>
        
        <!-- Tabs for Upload Methods -->
        <div class="upload-methods-tabs">
            <div class="method-tabs">
                <button class="method-tab active" data-method="csv" onclick="switchUploadMethod('csv')">
                    <i class="fas fa-file-csv"></i> Upload CSV
                </button>
                <button class="method-tab" data-method="manual" onclick="switchUploadMethod('manual')">
                    <i class="fas fa-edit"></i> Fill Student Data
                </button>
            </div>
        </div>
        
        <div class="modal-content">
            <!-- CSV Upload Section -->
            <div class="upload-section active" id="csvSection">
                <div class="upload-instructions">
                    <div class="instruction-card">
                        <div class="instruction-icon">
                            <i class="fas fa-file-download"></i>
                        </div>
                        <div class="instruction-content">
                            <h4>Step 1: Download Template</h4>
                            <p>Use our template to ensure proper formatting</p>
                            <button type="button" class="btn btn-outline" onclick="downloadCSVTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="instruction-card">
                        <div class="instruction-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="instruction-content">
                            <h4>Step 2: Upload & Edit</h4>
                            <p>Upload your CSV and edit directly in the table</p>
                            <small>You can edit all fields before saving</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="csvFile">Upload CSV File</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop CSV file or click to browse</p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('csvFile').click()">
                            Browse Files
                        </button>
                    </div>
                    <div class="file-preview" id="filePreview" style="display: none;">
                        <div class="file-info">
                            <i class="fas fa-file-csv"></i>
                            <div>
                                <strong id="fileName"></strong>
                                <small id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="clearFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Editable CSV Data Table -->
                <div class="editable-table-container" id="editableTableContainer" style="display: none;">
                    <div class="table-header">
                        <h4>Edit Student Data</h4>
                        <div class="table-controls">
                            <button type="button" class="btn btn-sm btn-outline" onclick="addNewRow()">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllRows()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="editable-table" id="editableTable">
                            <thead>
                                <tr>
                                    <th width="50">#</th>
                                    <th>Full Name</th>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th width="80">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="editableTableBody">
                                <!-- Rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-footer">
                        <div class="row-count">
                            <span id="rowCount">0</span> students in table
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveEditableTable()">
                            <i class="fas fa-save"></i> Save Students
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Manual Entry Section -->
            <div class="upload-section" id="manualSection">
                <div class="manual-entry-instructions">
                    <div class="instruction-card">
                        <div class="instruction-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="instruction-content">
                            <h4>Add Students Manually</h4>
                            <p>Fill in student details one by one or add multiple at once</p>
                        </div>
                    </div>
                </div>
                
                <div class="manual-entry-form">
                    <div class="form-row-header">
                        <h5>Add New Student</h5>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addManualStudent()">
                            <i class="fas fa-plus"></i> Add to List
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualName">Full Name *</label>
                            <input type="text" id="manualName" placeholder="John Doe" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="manualStudentId">Student ID *</label>
                            <input type="text" id="manualStudentId" placeholder="S12345" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="manualEmail">Email *</label>
                            <input type="email" id="manualEmail" placeholder="john@example.com" class="form-control">
                        </div>
                    </div>
                </div>
                
                <!-- Manual Entry Preview Table -->
                <div class="manual-preview-container">
                    <div class="table-header">
                        <h4>Students to Add</h4>
                        <div class="table-controls">
                            <button type="button" class="btn btn-sm btn-outline" onclick="clearManualList()">
                                <i class="fas fa-trash"></i> Clear List
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="manual-preview-table" id="manualPreviewTable">
                            <thead>
                                <tr>
                                    <th width="50">#</th>
                                    <th>Full Name</th>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th width="80">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="manualTableBody">
                                <!-- Manual entries will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-footer">
                        <div class="row-count">
                            <span id="manualRowCount">0</span> students in list
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveManualStudents()" id="saveManualBtn" disabled>
                            <i class="fas fa-save"></i> Save Students
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal-overlay" id="updateProgressModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="progressModalTitle">Update Student Progress</h3>
            <button class="modal-close" onclick="closeProgressModal()">&times;</button>
        </div>
        <div class="modal-content">
            <form id="updateProgressForm">
                <input type="hidden" id="studentIds" name="student_ids">
                
                <div class="form-group">
                    <label for="newProgress">New Academic Progress</label>
                    <div class="progress-selector">
                        <div class="progress-options">
                            {% for year in "1234"|make_list %}
                            <div class="progress-year">
                                <h5>Year {{ year }}</h5>
                                <div class="semester-options">
                                    {% for semester in "12"|make_list %}
                                    {% with progress=year|add:'.'|add:semester %}
                                    <label class="progress-option">
                                        <input type="radio" name="progress" value="{{ progress }}">
                                        <span class="option-label">{{ progress }}</span>
                                    </label>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifyStudent" name="notify_student">
                        <span class="checkmark"></span>
                        Notify student(s) about progress update
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeProgressModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Progress
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Processing...</p>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
    /* Batch Detail Management */
    .batch-detail-management {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-left {
        flex: 1;
    }

    .page-title {
        font-size: 1.75rem;
        color: #2c3e50;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-subtitle {
        font-size: 0.95rem;
        color: #7f8c8d;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    /* Batch Info Card */
    .batch-info-card {
        margin-bottom: 2rem;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e9ecef;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .batch-header-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
        color: white;
    }

    .batch-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 600;
        flex-shrink: 0;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .batch-details h2 {
        font-size: 1.5rem;
        margin: 0 0 0.5rem 0;
        color: white;
        font-weight: 600;
    }

    .batch-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }

    /* Tabs */
    .tabs-container {
        margin-bottom: 2rem;
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tabs {
        display: flex;
        border-bottom: 1px solid #e9ecef;
    }

    .tab-btn {
        flex: 1;
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-size: 1rem;
        font-weight: 500;
        color: #6c757d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .tab-btn:hover {
        background: #f8f9fa;
        color: #4361ee;
    }

    .tab-btn.active {
        color: #4361ee;
        border-bottom-color: #4361ee;
        background: #f8f9ff;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Upload Methods Tabs */
    .upload-methods-tabs {
        border-bottom: 1px solid #e9ecef;
        padding: 0 1.5rem;
    }

    .method-tabs {
        display: flex;
        gap: 0.5rem;
    }

    .method-tab {
        flex: 1;
        padding: 1rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-size: 0.95rem;
        font-weight: 500;
        color: #6c757d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .method-tab:hover {
        background: #f8f9fa;
        color: #4361ee;
    }

    .method-tab.active {
        color: #4361ee;
        border-bottom-color: #4361ee;
        background: #f8f9ff;
    }

    .upload-section {
        display: none;
    }

    .upload-section.active {
        display: block;
    }

    /* Editable Table Container */
    .editable-table-container,
    .manual-preview-container {
        margin-top: 2rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .table-header h4 {
        margin: 0;
        font-size: 1.1rem;
        color: #2c3e50;
    }

    .table-controls {
        display: flex;
        gap: 0.5rem;
    }

    .table-wrapper {
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
    }

    .editable-table,
    .manual-preview-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .editable-table th,
    .editable-table td,
    .manual-preview-table th,
    .manual-preview-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e9ecef;
        text-align: left;
    }

    .editable-table th,
    .manual-preview-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .editable-table tr:hover,
    .manual-preview-table tr:hover {
        background: #f8f9fa;
    }

    .editable-table td input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }

    .editable-table td input:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
    }

    .editable-table td input.error {
        border-color: #e74c3c;
        background: #fdf2f2;
    }

    .row-actions {
        display: flex;
        gap: 0.25rem;
    }

    .row-actions .btn-sm {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .table-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    .row-count {
        font-weight: 500;
        color: #2c3e50;
    }

    .row-count span {
        color: #4361ee;
        font-weight: 600;
    }

    /* Manual Entry Form */
    .manual-entry-form {
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .form-row-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .form-row-header h5 {
        margin: 0;
        font-size: 1rem;
        color: #2c3e50;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Upload Instructions */
    .upload-instructions,
    .manual-entry-instructions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .instruction-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        transition: transform 0.3s ease;
    }

    .instruction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .instruction-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(135deg, #4361ee, #3a56d4);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .instruction-content h4 {
        margin: 0 0 0.5rem 0;
        color: #2c3e50;
    }

    .instruction-content p {
        margin: 0 0 0.5rem 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* File Upload */
    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .file-upload-area:hover {
        border-color: #4361ee;
        background: #f8f9ff;
    }

    .file-upload-area i {
        font-size: 2rem;
        color: #4361ee;
        margin-bottom: 1rem;
    }

    .file-upload-area p {
        margin: 0 0 1rem 0;
        color: #6c757d;
    }

    .file-preview {
        margin-top: 1rem;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .file-info i {
        font-size: 1.5rem;
        color: #4361ee;
    }

    /* Students Management */
    .students-management {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .students-management .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .students-management .section-header h2 {
        font-size: 1.5rem;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .student-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-box {
        position: relative;
        width: 250px;
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #95a5a6;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Bulk Actions */
    .bulk-actions {
        background: #e3f2fd;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid #bbdefb;
    }

    .bulk-actions-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .bulk-actions-content span {
        font-weight: 600;
        color: #1976d2;
    }

    .bulk-buttons {
        display: flex;
        gap: 0.5rem;
    }

    /* Students Table */
    .students-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
    }

    .table-container {
        overflow-x: auto;
    }

    .students-table table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .students-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #eee;
        white-space: nowrap;
    }

    .students-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }

    .students-table tr:hover {
        background: #f8f9fa;
    }

    .students-table tr:last-child td {
        border-bottom: none;
    }

    /* Student Info Cell */
    .student-info-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 200px;
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .student-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .student-info-cell > div {
        flex: 1;
        min-width: 0;
    }

    .student-info-cell strong {
        display: block;
        font-size: 0.95rem;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }

    .student-info-cell small {
        display: block;
        font-size: 0.85rem;
        color: #7f8c8d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .student-details {
        flex: 1;
        min-width: 0;
    }

    .student-details strong {
        display: block;
        font-size: 0.95rem;
        color: #2c3e50;
        margin-bottom: 0.125rem;
    }

    .student-details small {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .student-id {
        font-family: monospace;
        background: #f8f9fa;
        padding: 0.125rem 0.25rem;
        border-radius: 4px;
        display: inline-block;
        font-size: 0.8rem;
    }

    /* Progress Badge */
    .progress-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .action-buttons .btn-sm {
        width: 36px;
        height: 36px;
        padding: 0;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .action-buttons .btn-danger {
        background: #fdf2f2;
        color: #e74c3c;
        border: 1px solid #f8d7da;
    }

    .action-buttons .btn-danger:hover {
        background: #e74c3c;
        color: white;
    }

    /* Progress Management */
    .progress-management {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .progress-management .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .progress-management .section-header h2 {
        font-size: 1.5rem;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Progress Timeline */
    .progress-timeline {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
    }

    .timeline-header {
        margin-bottom: 1.5rem;
    }

    .timeline-header h3 {
        font-size: 1.25rem;
        color: #2c3e50;
        margin: 0 0 0.5rem 0;
    }

    .timeline-year {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .timeline-year:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .year-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .year-header h4 {
        font-size: 1.1rem;
        color: #2c3e50;
        margin: 0;
    }

    .year-stats {
        font-size: 0.9rem;
        color: #6c757d;
        background: #f8f9fa;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }

    .semester-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .semester-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }

    .semester-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #4361ee;
        background: #f8f9ff;
    }

    .semester-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .semester-header h5 {
        font-size: 1rem;
        color: #2c3e50;
        margin: 0;
    }

    .student-count {
        font-size: 0.85rem;
        font-weight: 600;
        color: #4361ee;
        background: white;
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        border: 1px solid #4361ee;
    }

    .progress-indicator {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4cc9f0, #4895ef);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    /* Progress Statistics */
    .progress-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .progress-stats .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
        transition: transform 0.3s ease;
    }

    .progress-stats .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .progress-stats .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }

    .progress-stats .stat-card:nth-child(1) .stat-icon {
        background: linear-gradient(135deg, #4361ee, #3a56d4);
    }

    .progress-stats .stat-card:nth-child(2) .stat-icon {
        background: linear-gradient(135deg, #7209b7, #5a0a94);
    }

    .progress-stats .stat-card:nth-child(3) .stat-icon {
        background: linear-gradient(135deg, #4cc9f0, #4895ef);
    }

    /* Progress Selector */
    .progress-selector {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }

    .progress-year {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }

    .progress-year:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .progress-year h5 {
        margin: 0 0 0.75rem 0;
        color: #2c3e50;
    }

    .semester-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
    }

    .progress-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .progress-option input[type="radio"] {
        display: none;
    }

    .option-label {
        display: block;
        padding: 0.5rem;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        width: 100%;
    }

    .progress-option input[type="radio"]:checked + .option-label {
        background: #4361ee;
        color: white;
        border-color: #4361ee;
    }

    .progress-option:hover .option-label {
        border-color: #4361ee;
        background: #f8f9ff;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .modal-title {
        margin: 0;
        font-size: 1.5rem;
        color: #2c3e50;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #95a5a6;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #f8f9fa;
        color: #e74c3c;
    }

    .modal-content {
        padding: 1.5rem;
    }

    /* Modal Subheader */
    .modal-subheader {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .modal-subheader h4 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: #2c3e50;
    }

    .modal-search {
        width: 100%;
    }

    .modal-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
    }

    /* Students List Container */
    .students-list-container {
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .student-selection-options {
        padding: 0.75rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .select-all {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-info {
        font-size: 0.9rem;
        color: #4361ee;
        font-weight: 500;
    }

    .students-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .student-select-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
        background: white;
        transition: background 0.3s ease;
    }

    .student-select-item:hover {
        background: #f8f9ff;
    }

    .student-select-item:last-child {
        border-bottom: none;
    }

    .student-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .student-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        margin-left: 1rem;
        min-width: 150px;
        text-align: right;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .status-unassigned {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .status-other-batch {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffe0b2;
    }

    .status-current-batch {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .status-badge i {
        margin-right: 0.25rem;
    }

    .batch-info {
        font-size: 0.75rem;
        color: #95a5a6;
    }

    .transfer-note {
        padding: 0.75rem 1.5rem;
        background: #fff3e0;
        border-radius: 8px;
        border: 1px solid #ffe0b2;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .transfer-note i {
        color: #f57c00;
        margin-top: 0.125rem;
    }

    .transfer-note p {
        margin: 0;
        font-size: 0.85rem;
        color: #5d4037;
        flex: 1;
    }

    .empty-state-small {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .empty-state-small i {
        font-size: 2rem;
        color: #95a5a6;
        margin-bottom: 1rem;
    }

    .empty-state-small h4 {
        font-size: 1rem;
        color: #2c3e50;
        margin: 0 0 0.5rem 0;
    }

    .empty-state-small p {
        color: #6c757d;
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
    }

    .modal-actions {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .selected-summary {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        color: #2c3e50;
    }

    .selected-summary i {
        color: #4361ee;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
    }

    /* Loading Overlay */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .loading-spinner {
        text-align: center;
    }

    .loading-spinner i {
        font-size: 3rem;
        color: #4361ee;
        margin-bottom: 1rem;
        animation: spin 1s linear infinite;
    }

    .loading-spinner p {
        color: #2c3e50;
        font-weight: 500;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 12px;
        border: 1px solid #eee;
        margin: 2rem 0;
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4361ee, #3a56d4);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto 1.5rem auto;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        color: #2c3e50;
        margin: 0 0 0.5rem 0;
    }

    .empty-state p {
        color: #6c757d;
        margin: 0 0 1.5rem 0;
    }

    /* Checkbox Styling */
    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        gap: 0.5rem;
    }

    .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-radius: 4px;
        position: relative;
        transition: all 0.3s ease;
    }

    .checkbox-label input:checked + .checkmark {
        background: #4361ee;
        border-color: #4361ee;
    }

    .checkbox-label input:checked + .checkmark::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
    }

    /* Button Styles */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4361ee, #3a56d4);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-outline {
        background: transparent;
        color: #4361ee;
        border: 1px solid #4361ee;
    }

    .btn-outline:hover {
        background: #4361ee;
        color: white;
    }

    .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    /* Animations */
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .batch-header-info {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }

        .batch-meta {
            justify-content: center;
        }

        .tabs {
            overflow-x: auto;
        }

        .tab-btn {
            white-space: nowrap;
            padding: 1rem;
        }
        
        .method-tabs {
            overflow-x: auto;
        }
        
        .method-tab {
            white-space: nowrap;
            padding: 0.75rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .table-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .table-controls {
            align-self: flex-end;
        }

        .students-management .section-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .student-actions {
            width: 100%;
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            width: 100%;
        }

        .modal {
            width: 95%;
            margin: 1rem;
        }
        
        .student-select-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .student-status {
            align-self: flex-start;
            align-items: flex-start;
            text-align: left;
        }
        
        .modal-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .selected-summary {
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block script %}
<script>
    // Global variables
    let selectedStudents = new Set();
    let csvData = [];
    let manualStudents = [];
    
    // Get batch ID from data attribute
    function getBatchId() {
        const batchElement = document.querySelector('.batch-detail-management');
        return batchElement ? batchElement.getAttribute('data-batch-id') : null;
    }

    // Tab Management
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Upload Method Switching
    function switchUploadMethod(method) {
        // Update tab buttons
        document.querySelectorAll('.method-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-method') === method) {
                tab.classList.add('active');
            }
        });
        
        // Update sections
        document.querySelectorAll('.upload-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(method + 'Section').classList.add('active');
    }

    // CSV File Handling
    function setupCSVUpload() {
        const fileInput = document.getElementById('csvFile');
        const uploadArea = document.getElementById('fileUploadArea');
        
        fileInput.addEventListener('change', handleFileSelect);
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4361ee';
            uploadArea.style.background = '#f8f9ff';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.background = '#f8f9fa';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.background = '#f8f9fa';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
    }

    function handleFileSelect() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.name.endsWith('.csv')) {
            showError('Please select a CSV file');
            return;
        }
        
        // Update file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('filePreview').style.display = 'block';
        
        // Load and display CSV in editable table
        loadCSVToEditableTable(file);
    }

    function loadCSVToEditableTable(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvData = e.target.result;
            const rows = csvData.split('\n').filter(row => row.trim());
            
            if (rows.length === 0) {
                showError('CSV file is empty');
                return;
            }
            
            // Parse CSV
            const students = parseCSV(rows);
            displayEditableTable(students);
        };
        reader.readAsText(file);
    }

    function parseCSV(rows) {
        const students = [];
        const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
        
        // Find column indices
        const nameIndex = headers.indexOf('full_name') !== -1 ? headers.indexOf('full_name') : 
                         headers.indexOf('name') !== -1 ? headers.indexOf('name') : 0;
        const idIndex = headers.indexOf('student_id') !== -1 ? headers.indexOf('student_id') : 
                       headers.indexOf('studentid') !== -1 ? headers.indexOf('studentid') : 
                       headers.indexOf('id') !== -1 ? headers.indexOf('id') : 1;
        const emailIndex = headers.indexOf('email') !== -1 ? headers.indexOf('email') : 2;
        
        // Parse data rows
        for (let i = 1; i < rows.length; i++) {
            if (!rows[i].trim()) continue;
            
            const cells = rows[i].split(',');
            if (cells.length >= 3) {
                students.push({
                    full_name: (cells[nameIndex] || '').trim(),
                    student_id: (cells[idIndex] || '').trim(),
                    email: (cells[emailIndex] || '').trim()
                });
            }
        }
        
        return students;
    }

    function displayEditableTable(students) {
        const tableBody = document.getElementById('editableTableBody');
        tableBody.innerHTML = '';
        csvData = students;
        
        students.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <input type="text" 
                           value="${student.full_name}" 
                           class="editable-input name-input"
                           data-field="full_name"
                           data-index="${index}"
                           placeholder="Full Name">
                </td>
                <td>
                    <input type="text" 
                           value="${student.student_id}" 
                           class="editable-input id-input"
                           data-field="student_id"
                           data-index="${index}"
                           placeholder="Student ID">
                </td>
                <td>
                    <input type="email" 
                           value="${student.email}" 
                           class="editable-input email-input"
                           data-field="email"
                           data-index="${index}"
                           placeholder="Email">
                </td>
                <td>
                    <div class="row-actions">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Show the editable table
        document.getElementById('editableTableContainer').style.display = 'block';
        updateRowCount();
        
        // Add event listeners for editing
        document.querySelectorAll('.editable-input').forEach(input => {
            input.addEventListener('input', updateCSVData);
            input.addEventListener('blur', validateInput);
        });
    }

    function updateCSVData(e) {
        const input = e.target;
        const index = parseInt(input.getAttribute('data-index'));
        const field = input.getAttribute('data-field');
        
        if (csvData[index]) {
            csvData[index][field] = input.value;
        }
    }

    function validateInput(e) {
        const input = e.target;
        const value = input.value.trim();
        
        if (input.classList.contains('email-input') && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                input.classList.add('error');
            } else {
                input.classList.remove('error');
            }
        }
    }

    function addNewRow() {
        const newStudent = {
            full_name: '',
            student_id: '',
            email: ''
        };
        
        csvData.push(newStudent);
        displayEditableTable(csvData);
    }

    function removeRow(index) {
        if (confirm('Are you sure you want to remove this student?')) {
            csvData.splice(index, 1);
            displayEditableTable(csvData);
        }
    }

    function clearAllRows() {
        if (csvData.length > 0 && confirm('Are you sure you want to clear all students?')) {
            csvData = [];
            document.getElementById('editableTableBody').innerHTML = '';
            updateRowCount();
        }
    }

    function updateRowCount() {
        const count = csvData.length;
        document.getElementById('rowCount').textContent = count;
    }

    // Manual Student Entry
    function addManualStudent() {
        const name = document.getElementById('manualName').value.trim();
        const studentId = document.getElementById('manualStudentId').value.trim();
        const email = document.getElementById('manualEmail').value.trim();
        
        // Validate inputs
        if (!name || !studentId || !email) {
            showError('Please fill in all fields');
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError('Please enter a valid email address');
            return;
        }
        
        // Check for duplicates
        const isDuplicate = manualStudents.some(student => 
            student.student_id === studentId || student.email === email
        );
        
        if (isDuplicate) {
            showError('Student ID or email already exists in the list');
            return;
        }
        
        // Add to manual students list
        manualStudents.push({
            full_name: name,
            student_id: studentId,
            email: email
        });
        
        // Clear form
        document.getElementById('manualName').value = '';
        document.getElementById('manualStudentId').value = '';
        document.getElementById('manualEmail').value = '';
        
        // Update display
        displayManualStudents();
    }

    function displayManualStudents() {
        const tableBody = document.getElementById('manualTableBody');
        tableBody.innerHTML = '';
        
        manualStudents.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.full_name}</td>
                <td>${student.student_id}</td>
                <td>${student.email}</td>
                <td>
                    <div class="row-actions">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeManualStudent(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Update counts
        document.getElementById('manualRowCount').textContent = manualStudents.length;
        document.getElementById('saveManualBtn').disabled = manualStudents.length === 0;
    }

    function removeManualStudent(index) {
        if (confirm('Are you sure you want to remove this student?')) {
            manualStudents.splice(index, 1);
            displayManualStudents();
        }
    }

    function clearManualList() {
        if (manualStudents.length > 0 && confirm('Are you sure you want to clear all students?')) {
            manualStudents = [];
            displayManualStudents();
        }
    }

    // Save Functions
    async function saveEditableTable() {
        if (csvData.length === 0) {
            showError('No student data to save');
            return;
        }
        
        // Validate all data
        const errors = [];
        csvData.forEach((student, index) => {
            if (!student.full_name.trim()) {
                errors.push(`Row ${index + 1}: Full name is required`);
            }
            if (!student.student_id.trim()) {
                errors.push(`Row ${index + 1}: Student ID is required`);
            }
            if (!student.email.trim()) {
                errors.push(`Row ${index + 1}: Email is required`);
            } else {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(student.email)) {
                    errors.push(`Row ${index + 1}: Invalid email format`);
                }
            }
        });
        
        if (errors.length > 0) {
            showError('Please fix the following errors:\n' + errors.join('\n'));
            return;
        }
        
        await saveStudents(csvData, 'csv');
    }

    async function saveManualStudents() {
        if (manualStudents.length === 0) {
            showError('No student data to save');
            return;
        }
        
        await saveStudents(manualStudents, 'manual');
    }

    async function saveStudents(students, method) {
        const batchId = getBatchId();
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        showLoading();
        try {
            const response = await fetch(`/api/batches/${batchId}/register-new-students/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    students: students,
                    bulk_method: method
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                showSuccess(`${result.added || result.message || 'Student(s) added successfully!'}`);
                setTimeout(() => {
                    closeCSVUploadModal();
                    location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to add students');
            }
        } catch (error) {
            showError('Error adding students: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Utility Functions
    function downloadCSVTemplate() {
        const csvContent = 'full_name,student_id,email\nJohn Doe,S12345,john@example.com\nJane Smith,S12346,jane@example.com';
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'student_template.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function clearFile() {
        document.getElementById('csvFile').value = '';
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('editableTableContainer').style.display = 'none';
        csvData = [];
        updateRowCount();
    }

    function closeCSVUploadModal() {
        document.getElementById('csvUploadModal').style.display = 'none';
        resetCSVUpload();
    }

    function resetCSVUpload() {
        clearFile();
        manualStudents = [];
        document.getElementById('manualTableBody').innerHTML = '';
        document.getElementById('manualRowCount').textContent = '0';
        document.getElementById('saveManualBtn').disabled = true;
        document.getElementById('manualName').value = '';
        document.getElementById('manualStudentId').value = '';
        document.getElementById('manualEmail').value = '';
        
        // Reset to CSV tab
        switchUploadMethod('csv');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Student Selection Management
    function toggleSelectAll(checkbox) {
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        studentCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
        updateBulkActions();
    }

    function updateBulkActions() {
        const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
        const bulkActions = document.getElementById('bulkActions');
        
        if (selectedCount > 0) {
            bulkActions.style.display = 'block';
            document.getElementById('selectedCount').textContent = selectedCount;
        } else {
            bulkActions.style.display = 'none';
        }
    }

    function clearSelection() {
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
    }

    // Modal Management Functions
    function openAddStudentsModal() {
        document.getElementById('addStudentsModal').style.display = 'flex';
    }

    function closeAddStudentsModal() {
        document.getElementById('addStudentsModal').style.display = 'none';
    }

    function openCSVUploadModal() {
        document.getElementById('csvUploadModal').style.display = 'flex';
        resetCSVUpload();
    }

    // Student Management Functions
    function removeStudent(studentId, studentName) {
        const batchId = getBatchId();
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        if (confirm(`Are you sure you want to remove ${studentName} from this batch?`)) {
            showLoading();
            fetch(`/api/batches/${batchId}/remove_student/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ student_ids: [studentId] })
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Student removed successfully!');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Failed to remove student');
                }
            })
            .catch(error => {
                showError('Error removing student: ' + error.message);
            })
            .finally(() => hideLoading());
        }
    }

    function removeSelectedStudents() {
        const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showError('Please select at least one student');
            return;
        }
        
        const studentIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const studentCount = studentIds.length;
        const batchId = getBatchId();
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        if (confirm(`Are you sure you want to remove ${studentCount} student(s) from this batch?`)) {
            showLoading();
            fetch(`/api/batches/${batchId}/remove_student/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ student_ids: studentIds })
            })
            .then(response => {
                if (response.ok) {
                    showSuccess(`${studentCount} student(s) removed successfully!`);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Failed to remove students');
                }
            })
            .catch(error => {
                showError('Error removing students: ' + error.message);
            })
            .finally(() => hideLoading());
        }
    }

    // Progress Management
    function updateSelectedProgress() {
        const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showError('Please select at least one student');
            return;
        }
        
        const studentIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        document.getElementById('studentIds').value = studentIds.join(',');
        document.getElementById('progressModalTitle').textContent = `Update Progress for ${studentIds.length} Students`;
        document.getElementById('updateProgressModal').style.display = 'flex';
    }

    function closeProgressModal() {
        document.getElementById('updateProgressModal').style.display = 'none';
    }

    async function updateProgress() {
        const studentIds = document.getElementById('studentIds').value.split(',').filter(id => id);
        const progress = document.querySelector('input[name="progress"]:checked')?.value;
        const notifyStudent = document.getElementById('notifyStudent').checked;
        const batchId = getBatchId();
        
        if (!progress) {
            showError('Please select a progress level');
            return;
        }
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        showLoading();
        try {
            const response = await fetch(`/api/batches/${batchId}/update-progress/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    student_ids: studentIds,
                    progress_year: progress,
                    notify_student: notifyStudent
                })
            });
            
            if (response.ok) {
                showSuccess('Progress updated successfully!');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to update progress');
            }
        } catch (error) {
            showError('Error updating progress: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function advanceEntireBatch() {
        const batchId = getBatchId();
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        if (confirm('Are you sure you want to advance the entire batch to the next semester? This action cannot be undone.')) {
            showLoading();
            fetch(`/api/batches/${batchId}/advance-batch/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Batch advanced successfully!');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Failed to advance batch');
                }
            })
            .catch(error => {
                showError('Error advancing batch: ' + error.message);
            })
            .finally(() => hideLoading());
        }
    }

    function viewStudentsInProgress(progress) {
        alert(`View students in progress ${progress} - This feature would show students at this academic level`);
    }

    // Add Students Modal Functions
    function toggleSelectAllModal(checkbox) {
        const visibleCheckboxes = document.querySelectorAll('#studentsList .student-select-checkbox:not([style*="display: none"])');
        
        visibleCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                selectedStudents.add(cb.value);
            } else {
                selectedStudents.delete(cb.value);
            }
        });
        
        updateSelectionCount();
        updateAddButton();
    }

    function updateSelectionCount() {
        const checkboxes = document.querySelectorAll('#studentsList .student-select-checkbox:checked');
        const countElement = document.getElementById('selectedStudentsCount');
        const selectAllCheckbox = document.getElementById('selectAllStudents');
        
        if (countElement) {
            countElement.textContent = checkboxes.length;
        }
        
        // Update selected students set
        const allCheckboxes = document.querySelectorAll('#studentsList .student-select-checkbox');
        allCheckboxes.forEach(cb => {
            if (cb.checked) {
                selectedStudents.add(cb.value);
            } else {
                selectedStudents.delete(cb.value);
            }
        });
        
        // Update total count
        updateTotalSelectionCount();
        updateAddButton();
        
        // Update select all checkbox state
        if (selectAllCheckbox) {
            const visibleCheckboxes = document.querySelectorAll('#studentsList .student-select-checkbox:not([style*="display: none"])');
            const allVisibleChecked = visibleCheckboxes.length > 0 && 
                                   Array.from(visibleCheckboxes).every(cb => cb.checked);
            
            selectAllCheckbox.checked = allVisibleChecked;
            selectAllCheckbox.indeterminate = checkboxes.length > 0 && !allVisibleChecked;
        }
    }

    function updateTotalSelectionCount() {
        const totalCount = selectedStudents.size;
        document.getElementById('totalSelectedCount').textContent = totalCount;
    }

    function updateAddButton() {
        const addButton = document.getElementById('addStudentsBtn');
        addButton.disabled = selectedStudents.size === 0;
    }

    function clearAllSelection() {
        selectedStudents.clear();
        
        // Uncheck all checkboxes
        document.querySelectorAll('.student-select-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        // Reset select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllStudents');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
        
        // Update counts
        updateSelectionCount();
        updateAddButton();
    }

    function filterStudents() {
        const searchInput = document.getElementById('studentSearch');
        const searchTerm = searchInput.value.toLowerCase();
        const items = document.querySelectorAll('#studentsList .student-select-item');
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
        });
        
        // Update selection counts
        updateSelectionCount();
    }

    async function addSelectedStudents() {
        if (selectedStudents.size === 0) {
            showError('Please select at least one student');
            return;
        }
        
        const studentIds = Array.from(selectedStudents);
        const batchId = getBatchId();
        
        if (!batchId) {
            showError('Could not identify the batch. Please refresh the page.');
            return;
        }
        
        showLoading();
        try {
            const response = await fetch(`/api/batches/${batchId}/add_students/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    student_ids: studentIds
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                showSuccess(`${result.added || result.message || 'Student(s) added successfully!'}`);
                
                setTimeout(() => {
                    closeAddStudentsModal();
                    location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to add students');
            }
        } catch (error) {
            showError('Error adding students: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Utility Functions
    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showSuccess(message) {
        // You can replace this with a better notification system
        alert('Success: ' + message);
    }

    function showError(message) {
        // You can replace this with a better notification system
        alert('Error: ' + message);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Setup CSV upload
        setupCSVUpload();
        
        // Setup event listeners
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            cb.addEventListener('change', updateBulkActions);
        });
        
        // Setup form submissions
        document.getElementById('updateProgressForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            updateProgress();
        });
        
        // Initialize search in main table
        document.getElementById('searchStudent')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.students-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        
        // Initialize modal search
        document.getElementById('studentSearch')?.addEventListener('input', () => {
            filterStudents();
        });
    });
</script>
{% endblock %}